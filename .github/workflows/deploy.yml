name: Build and Trigger Central Deploy

on:
  push:
    branches:
      - master

jobs:
  build:
    name: Build Mule Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build Mule Project
        env:
          ANYPOINT_CONNECTED_APP_CLIENT_ID: ${{ secrets.ANYPOINT_CONNECTED_APP_CLIENT_ID }}
          ANYPOINT_CONNECTED_APP_CLIENT_SECRET: ${{ secrets.ANYPOINT_CONNECTED_APP_CLIENT_SECRET }}
        run: mvn clean package -s settings.xml -B

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: mule-app
          path: target/*.jar

  package:
    name: Package and Validate
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: mule-app

      - name: Verify artifact presence
        run: |
          echo "Verifying artifact from previous build..."
          ls -l target || echo "Target folder missing, build failed!"
          ls -l

      - name: Optional Static Analysis / Validation
        run: echo "Perform static code validation or scanning here if needed."

  trigger-deploy:
    name: Trigger Central Workflow
    runs-on: ubuntu-latest
    needs: package

    steps:
      - name: Trigger deployment workflow in main repo
        run: |
          echo "Triggering central deployment workflow..."
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.PAT }}" \
            https://api.github.com/repos/aanyabajetha/maven-deployment-workflow/dispatches \
            -d '{
              "event_type": "deploy-trigger",
              "client_payload": {
                "repo_owner": "aanyabajetha",
                "repo": "payment-audit-v1",
                "applicationName": "payment-audit-v1-sandbox",
                "app_name": "payment-audit-v1-sandbox",
                "anypoint_uri": "https://anypoint.mulesoft.com",
                "anypoint_provider": "MC",
                "anypoint_env": "Sandbox",
                "anypoint_target": "Cloudhub-US-East-2",
                "replicas": "1",
                "vCores": "0.1"
              }
            }'
